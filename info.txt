# **Privacy Policy for [App Name]**

**Last Updated:** [Date]

[App Name] (“we,” “our,” or “us”) is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our mobile application (“App”) and related services. Please read this policy carefully.

---

## **1. Information We Collect**

### **1.1 Personal Information**

We may collect the following personal data when you register or use the App:

* Full name
* Username
* Email address
* Phone number
* Profile photo
* Location (city/state level — not real-time GPS unless you enable it)
* Payment information (handled securely through third-party payment processors)

### **1.2 Usage Data**

This may include:

* Device information (model, OS version)
* App activity (features used, screens visited)
* IP address
* Log data and crash analytics

### **1.3 Content You Provide**

* Job postings
* Bids, proposals, and messages
* Uploaded files (documents, images, etc.)

### **1.4 Third-Party Data**

If you choose to sign in using Google, Apple, Facebook, or another provider, we may receive information such as:

* Name
* Email
* Profile picture

---

## **2. How We Use Your Information**

We use collected data to:

* Create and manage user accounts
* Enable job posting, bidding, messaging, and payments
* Improve app performance and user experience
* Personalize content and features
* Send alerts, updates, or promotional messages
* Detect fraud, ensure security, and enforce policies
* Provide customer support

---

## **3. Sharing Your Information**

We may share information with:

### **3.1 Service Providers**

* Payment processors
* Cloud hosting services
* Analytics and crash reporting tools
* Identity verification services

### **3.2 Other Users**

Information such as your profile, name, rating, and job history may be visible to other users within the app.

### **3.3 Legal Obligations**

We may disclose information if required by:

* Law enforcement
* Court orders
* Government requests

### **3.4 Business Transfers**

If we merge, acquire, or transfer company assets, your data may be included.

---

## **4. Data Security**

We implement appropriate technical and organizational security measures to protect your personal information.
However, no system is completely secure, and we cannot guarantee absolute security.

---

## **5. Children's Privacy**

[App Name] is not intended for individuals under **18 years**. We do not knowingly collect information from minors.
If you believe a minor has provided us with data, contact us at **[Contact Email]**.

---

## **6. Your Privacy Rights**

Depending on your location, you may have the right to:

* Access the data we hold about you
* Request corrections or updates
* Delete your account or personal data
* Opt out of marketing communications
* Withdraw consent where applicable

To exercise these rights, contact **[Contact Email]**.

---

## **7. Data Retention**

We retain your information:

* As long as your account is active
* As necessary to provide services
* As required to comply with legal obligations

When your data is no longer needed, we securely delete or anonymize it.

---

## **8. Third-Party Links**

Our App may contain links to third-party websites or services.
We are not responsible for their privacy practices or content.

---

## **9. International Data Transfers**

Your information may be transferred to and stored on servers outside your country.
We take steps to ensure data protection laws are followed during such transfers.

---

## **10. Changes to This Policy**

We may update this Privacy Policy from time to time.
We will notify you by:

* Updating the “Last Updated” date, and
* Sending an in-app notification where appropriate

---

## **11. Contact Us**

If you have questions or concerns about this Privacy Policy, contact us at:

**[Company Name]**
**Email:** [Contact Email]
**Phone:** [Optional]
**Address:** [Optional]

---

If you want, I can also create:
✅ Terms & Conditions
✅ Cookie Policy
✅ Refund Policy
✅ User Agreement
…or turn this into a **PDF**.
*/


// ChatDetails.tsx
import { AntDesign } from "@expo/vector-icons";
import React, { useState, useCallback, useEffect, useRef } from "react";
import { View, Text, StyleSheet, Dimensions, Platform, KeyboardAvoidingView, TouchableOpacity } from "react-native";
import {
  GiftedChat,
  Bubble,
  InputToolbar,
  Send,
  IMessage,
  InputToolbarProps,
  SendProps,
  BubbleProps,
} from "react-native-gifted-chat";
import { widthPercentageToDP as wp, heightPercentageToDP as hp } from "react-native-responsive-screen";
import { StatusBar } from "expo-status-bar";
import { connectChatSocket } from "../../../services/ws";
import { getConversation, sendMessage } from "../../../services/message";
import { SafeAreaView } from "react-native-safe-area-context";
import { useNavigation, RouteProp, useRoute, NavigationProp, useFocusEffect } from '@react-navigation/native';
import { UserStackParamList } from "../../../types/types";
import { useAuthStore } from "../../../services/AuthContext";

// Helper to ensure a backend message (any shape) becomes an IMessage
const formatMessage = (m: any): IMessage => ({
  _id: m.id ?? m._id ?? Math.random().toString(), // fallback id
  text: m.content ?? m.text ?? "",
  createdAt: m.sent_at ? new Date(m.sent_at) : m.createdAt ? new Date(m.createdAt) : new Date(),
  user: {
    _id: m.sender_id ?? m.user?._id ?? 0,
    ...(m.user?.name ? { name: m.user.name } : {}),
    ...(m.user?.avatar ? { avatar: m.user.avatar } : {}),
  },
});

type ChatScreenNavigationProp = RouteProp<UserStackParamList, 'chatDetails'>;

export function ChatDetails() {
  const [messages, setMessages] = useState<IMessage[]>([]);
  const wsRef = useRef<WebSocket | null>(null);
  const route = useRoute<ChatScreenNavigationProp>();
  const { id, receiver_id } = route.params;
  const key = useAuthStore((s) => s.token);
  const token = `${key}`;
  const user_id = useAuthStore((s) => s.user.id);
  // NOTE: replace with real token or pass it as prop/context
  

  const loadMessages = async () => {
    try {
      // getConversation returns backend rows; convert to GiftedChat format
      const backendMessages = await getConversation(receiver_id, id, token);
      const formatted = backendMessages.map((m: any) => formatMessage(m));
      // GiftedChat expects most recent first, usually -> keep your existing order if correct
      setMessages(formatted.reverse());
    } catch (err) {
      console.warn("Failed to load messages:", err);
    }
  };

  useEffect(() => {
    loadMessages();
    // run once on mount
  }, []);

  useEffect(() => {
    // connectChatSocket will send raw backend message shape; format it before appending
    const ws = connectChatSocket(token, (rawMsg: any) => {
      try {
        // If this message belongs to the current job/receiver logic, check fields accordingly
        // Example check (adjust depending on server payload):
        if (rawMsg.job_id === id) {
          const formatted = formatMessage(rawMsg);
          //setMessages(prev => GiftedChat.append(prev, formatted));
        }
      } catch (e) {
        console.warn("Error processing websocket message:", e);
      }
    });

    wsRef.current = ws;
    return () => {
      try {
        ws.close();
      } catch (e) {}
      wsRef.current = null;
    };
  }, [token]); // depends only on token (or props you pass)

  const onSend = useCallback(async (newMessages: IMessage[] = []) => {
    if (!newMessages.length) return;

    const clientMsg = newMessages[0];

    try {
      const savedBackend = await sendMessage(
        {
          content: clientMsg.text,
          receiver_id: receiver_id,
          job_id: id,
        },
        token
      );

      // sendMessage already returns a formatted GiftedChat object in the service,
      // but normalize again to be robust:
      const formatted = formatMessage(savedBackend);
      //setMessages(prev => GiftedChat.append(prev, formatted));
    } catch (err) {
      console.warn("Failed to send message:", err);
      // Optionally you can still append the optimistic message:
      // setMessages(prev => GiftedChat.append(prev, clientMsg));
    }
  }, [token]);

  const renderInputToolBar = (props: React.JSX.IntrinsicAttributes & InputToolbarProps<IMessage>) => (
    <InputToolbar
      {...props}
      containerStyle={{
        borderRadius: 10,
        backgroundColor: "#f2f8fc",
        marginHorizontal: 8,
        marginTop: 5,
        borderWidth: 0,
        bottom: hp('1%'),
      }}
    />
  );

  const renderSend = (props: React.JSX.IntrinsicAttributes & SendProps<IMessage>) => (
    <Send {...props}>
      <View style={{ marginBottom: 12, paddingTop: 5 }}>
        <AntDesign name="send" size={24} color="#0075FD" />
      </View>
    </Send>
  );

  const renderBubble = (props: React.JSX.IntrinsicAttributes & BubbleProps<IMessage>) => (
    <Bubble
      {...props}
      wrapperStyle={{
        left: { backgroundColor: "#f2f8fc" },
        right: { backgroundColor: "#0075FD" },
      }}
    />
  );

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity style={{top: hp('0.5%')}} onPress={() => console.log(token)}>
          <AntDesign name="arrow-left" size={24} color='black' />
        </TouchableOpacity>
        <Text style={styles.heading}>Chat with AI</Text>
      </View>

      <View style={styles.chatView}>
        <GiftedChat
          messages={messages}
          onSend={onSend}
          user={{
            _id: user_id, // current_user_id
          }}
          renderAvatar={null}
          renderBubble={renderBubble}
          renderInputToolbar={renderInputToolBar}
          renderSend={renderSend}
        />
      </View>

      {Platform.OS === "android" && <KeyboardAvoidingView behavior="padding" />}
      <StatusBar style="auto" />
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { 
    flex: 1, 
    backgroundColor: "#fff" 
  },
  header: {
    height: hp('7%'),
    flexDirection: 'row',
    padding: 10,
    bottom: hp('3%'),
  },
  heading: { 
    fontWeight: "500", 
    paddingLeft: 16, 
    fontSize: 20 
  },
  headerName: { 
    fontSize: 25, 
    fontWeight: "400" 
  },
  headerImg: { 
    width: wp("15%"), 
    height: hp("6%"), 
    borderRadius: 50, 
    resizeMode: "contain" 
  },
  msgView: { 
    bottom: 56, 
    flexDirection: "row", 
    gap: wp("2%"), 
    padding: 5 
  },
  textInput: { 
    borderWidth: 2, 
    width: wp("80%"), 
    height: hp("7%"), 
    borderRadius: 10, 
    borderColor: "#184d85", 
    padding: 5 
  },
  btn: { 
    width: wp("15%"), 
    height: hp("7%"), 
    borderRadius: 10, 
    alignItems: "center", 
    justifyContent: "center", 
    backgroundColor: "#184d85" 
  },
  chatView: {
    marginBottom: 50,
    backgroundColor: 'white',
    width: wp('100%'),
    height: hp('90%'),
  },
});
